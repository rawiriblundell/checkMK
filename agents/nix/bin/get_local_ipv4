#!/bin/ksh
# vim: noai:ts=4:sw=4:expandtab

# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# Start with the 'ip' command
if command -v ip >/dev/null 2>&1; then
    ip -o -4 a show up | awk -F '[ /]' '/brd/{print $7}'
    exit "$?"
# Failover to 'ifconfig'
elif command -v inpath ifconfig >/dev/null 2>&1; then
    ifconfig -a \
        | awk -F ':' '/inet addr/{print $2}' \
        | awk '{print $1}' \
        | grep -v "127.0.0.1"
    exit "${?}"
fi

# If we get to this point, we hope that DNS is working
if command -v nslookup >/dev/null 2>&1; then
    # Because nslookup exits with 0 even on failure, we test for failure first
    if nslookup "$(hostname)" 2>&1 \
            | grep -E "Server failed|SERVFAIL|can't find" >/dev/null 2>&1; then
        printf -- '%s\n' "Could not determine the local IP address"
        exit 1
    else
        nslookup "$(hostname)" \
        | awk -F ':' '/Address:/{gsub(/ /, "", $2); print $2}' \
        | grep -v "#"
        exit "${?}"
    fi
fi

# If we get to this point, exit with a failure code
exit 1